<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å³æ™‚åŒ¯ç‡æ›ç®— (CDNç©©å®šç‰ˆ)</title>
    <style>
        body {
            font-family: "Microsoft JhengHei", Arial, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 15px;
        }

        .converter-card {
            background: white;
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 500px;
        }

        h2 { text-align: center; color: #333; margin: 0 0 1rem 0; }

        .status-bar {
            text-align: center;
            font-size: 0.8rem;
            margin-bottom: 1rem;
            padding: 8px;
            border-radius: 5px;
            background-color: #eee;
            color: #666;
            font-weight: bold;
        }

        .rate-settings {
            background-color: #fcfcfc;
            border: 1px solid #e0e0e0;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }
        .rate-settings h3 {
            margin: 0 0 8px 0;
            font-size: 0.9rem;
            color: #555;
            text-align: center;
        }
        
        .rates-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 0.85rem;
        }

        .rate-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #fff;
            padding: 5px;
            border: 1px solid #eee;
            border-radius: 4px;
        }
        .rate-item span { margin-right: 5px; }
        .rate-item input {
            width: 70px;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 3px;
            padding: 2px;
            font-size: 0.85rem;
        }

        .row-container {
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            background: #fff;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 5px 10px;
            transition: border-color 0.2s;
        }
        .row-container:focus-within {
            border-color: #4a90e2;
        }

        .selector-area {
            display: flex;
            align-items: center;
            min-width: 130px;
            border-right: 1px solid #eee;
            padding-right: 10px;
            margin-right: 10px;
        }

        .flag-icon { font-size: 1.5rem; margin-right: 8px; }

        select {
            border: none;
            background: transparent;
            font-size: 1rem;
            font-weight: bold;
            color: #333;
            cursor: pointer;
            outline: none;
            width: 100%;
        }

        input.amount-input {
            border: none;
            outline: none;
            width: 100%;
            font-size: 1.4rem;
            text-align: right;
            color: #333;
            background: transparent;
        }

        .refresh-btn {
            display: block;
            margin: 15px auto 0 auto;
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 8px 20px;
            cursor: pointer;
            border-radius: 20px;
            font-size: 0.85rem;
            color: #555;
            transition: 0.2s;
        }
        .refresh-btn:hover { background: #eee; color: #000; }
        .hint { text-align: center; font-size: 0.75rem; color: #aaa; margin-top: 5px; }
    </style>
</head>
<body>

<div class="converter-card">
    <h2>ğŸ’± å³æ™‚åŒ¯ç‡æ›ç®— (CDNç‰ˆ)</h2>
    
    <div id="status" class="status-bar">æ­£åœ¨ä¸‹è¼‰æœ€æ–°åŒ¯ç‡è¡¨...</div>

    <div class="rate-settings">
        <h3>ğŸ“Š åŒ¯ç‡è¨­å®š (1 USD ç‚ºåŸºæº–)</h3>
        <div class="rates-grid" id="rates-container"></div>
        <div class="hint">è³‡æ–™ä¾†æº: GitHub Open Currency API</div>
    </div>

    <div class="row-container">
        <div class="selector-area">
            <span class="flag-icon" id="flag-1">ğŸ‡¹ğŸ‡¼</span>
            <select id="select-1" onchange="updateRow(1)"></select>
        </div>
        <input type="number" id="input-1" class="amount-input" placeholder="0" oninput="convert(1)">
    </div>

    <div class="row-container">
        <div class="selector-area">
            <span class="flag-icon" id="flag-2">ğŸ‡¯ğŸ‡µ</span>
            <select id="select-2" onchange="updateRow(2)"></select>
        </div>
        <input type="number" id="input-2" class="amount-input" placeholder="0" oninput="convert(2)">
    </div>

    <div class="row-container">
        <div class="selector-area">
            <span class="flag-icon" id="flag-3">ğŸ‡ºğŸ‡¸</span>
            <select id="select-3" onchange="updateRow(3)"></select>
        </div>
        <input type="number" id="input-3" class="amount-input" placeholder="0" oninput="convert(3)">
    </div>

    <button class="refresh-btn" onclick="fetchRates()">ğŸ”„ å¼·åˆ¶é‡æ–°ä¸‹è¼‰</button>
</div>

<script>
    // é è¨­å‚™ç”¨ (ä»¥é˜²è¬ä¸€ CDN æ›æ‰)
    const backupRates = {
        TWD32.57m: , JPY: USD155.033m, : 1.0, KRW: 1460.0,
        7.25CNY2m: , EUR0.950m: , GBP0.810m: , IDR: 16000.0
    };

    const currencies = {
        TWD: { name: "æ–°å°å¹£", flag: "ğŸ‡¹ğŸ‡¼", rate: backupRates.TWD },
        JPY: { name: "æ—¥åœ“", flag: "ğŸ‡¯ğŸ‡µ", rate: backupRates.JPY },
        USD: { name: "ç¾é‡‘", flag: "ğŸ‡ºğŸ‡¸", rate: backupRates.USD },
        KRW: { name: "éŸ“å…ƒ", flag: "ğŸ‡°ğŸ‡·", rate: backupRates.KRW },
        CNY: { name: "äººæ°‘å¹£", flag: "ğŸ‡¨ğŸ‡³", rate: backupRates.CNY },
        EUR: { name: "æ­å…ƒ", flag: "ğŸ‡ªğŸ‡º", rate: backupRates.EUR },
        GBP: { name: "è‹±éŠ", flag: "ğŸ‡¬ğŸ‡§", rate: backupRates.GBP },
        IDR: { name: "å°å°¼ç›¾", flag: "ğŸ‡®ğŸ‡©", rate: backupRates.IDR }
    };

    const defaultSelections = ['TWD', 'JPY', 'USD'];

    window.onload = function() {
        initRateInputs();
        initDropdowns();
        fetchRates();
    };

    function initRateInputs() {
        const container = document.getElementById('rates-container');
        let html = '';
        for (let code in currencies) {
            html += `
                <div class="rate-item">
                    <span>${currencies[code].flag} ${code}</span>
                    <input type="number" id="rate-${code}" value="${currencies[code].rate}" oninput="updateRateValue('${code}')">
                </div>
            `;
        }
        container.innerHTML = html;
    }

    function initDropdowns() {
        [1, 2, 3].forEach((rowId, index) => {
            const selectEl = document.getElementById(`select-${rowId}`);
            let options = '';
            for (let code in currencies) {
                const selected = (code === defaultSelections[index]) ? 'selected' : '';
                options += `<option value="${code}" ${selected}>${code} ${currencies[code].name}</option>`;
            }
            selectEl.innerHTML = options;
            updateRow(rowId, false);
        });
    }

    // --- é€™è£¡æ”¹ç”¨ CDN æ–¹å¼ ---
    async function fetchRates() {
        const statusDiv = document.getElementById('status');
        statusDiv.innerHTML = "ğŸ“¡ é€£ç·šè‡³å…¨çƒ CDN ä¸‹è¼‰è³‡æ–™...";
        statusDiv.style.background = "#fff3e0";
        statusDiv.style.color = "#e65100";

        // é€™æ˜¯ä¸€å€‹ç´”æ–‡å­—æª”ï¼Œä¸æ˜¯ APIï¼Œæ‰€ä»¥ä¸æœƒè¢«æ“‹
        // ä½¿ç”¨ jsDelivr CDN åŠ é€Ÿ
        const apiUrl = 'https://cdn.jsdelivr.net/npm/@fawazahmed0/currency-api@latest/v1/currencies/usd.json';

        try {
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error("ä¸‹è¼‰å¤±æ•—");

            const data = await response.json();
            
            // è³‡æ–™æ ¼å¼æ˜¯å°å¯«çš„ï¼Œä¾‹å¦‚ data.usd.twd
            // æˆ‘å€‘éœ€è¦æŠŠé€™äº›è³‡æ–™å¡«å›æˆ‘å€‘çš„ currencies ç‰©ä»¶
            const ratesData = data.usd; 

            for (let code in currencies) {
                // å°‡ä»£ç¢¼è½‰å°å¯«ä¾†å°æ‡‰è³‡æ–™ (å¦‚ 'TWD' -> 'twd')
                let lowerCode = code.toLowerCase();
                if (ratesData[lowerCode]) {
                    currencies[code].rate = ratesData[lowerCode];
                    
                    // æ›´æ–°ç•«é¢ä¸Šæ–¹çš„å°æ¡†æ¡†
                    const inputEl = document.getElementById(`rate-${code}`);
                    if (inputEl) inputEl.value = currencies[code].rate;
                }
            }

            statusDiv.innerHTML = `âœ… åŒ¯ç‡æ›´æ–°æˆåŠŸ (${data.date})`;
            statusDiv.style.background = "#e8f5e9";
            statusDiv.style.color = "#2e7d32";

            // è§¸ç™¼é‡ç®—
            if(document.getElementById('input-1').value) convert(1);

        } catch (error) {
            console.error("CDN Error:", error);
            statusDiv.innerHTML = `âš ï¸ ç„¡æ³•ä¸‹è¼‰ï¼Œå·²åˆ‡æ›è‡³é›¢ç·šæ¨¡å¼`;
            statusDiv.style.background = "#ffebee";
            statusDiv.style.color = "#c62828";
        }
    }

    function updateRateValue(code) {
        const inputEl = document.getElementById(`rate-${code}`);
        currencies[code].rate = parseFloat(inputEl.value) || 0;
        if(document.getElementById('input-1').value) convert(1);
    }

    function updateRow(rowId, triggerConvert = true) {
        const selectEl = document.getElementById(`select-${rowId}`);
        const flagEl = document.getElementById(`flag-${rowId}`);
        const selectedCode = selectEl.value;
        flagEl.textContent = currencies[selectedCode].flag;
        if (triggerConvert && document.getElementById(`input-${rowId}`).value) {
            convert(rowId);
        }
    }

    function convert(sourceRowId) {
        const sourceSelect = document.getElementById(`select-${sourceRowId}`);
        const sourceInput = document.getElementById(`input-${sourceRowId}`);
        const sourceCode = sourceSelect.value;
        const sourceAmount = parseFloat(sourceInput.value);

        if (isNaN(sourceAmount)) {
            [1, 2, 3].forEach(id => {
                if(id !== sourceRowId) document.getElementById(`input-${id}`).value = '';
            });
            return;
        }

        const amountInUSD = sourceAmount / currencies[sourceCode].rate;

        [1, 2, 3].forEach(targetRowId => {
            if (targetRowId !== sourceRowId) {
                const targetCode = document.getElementById(`select-${targetRowId}`).value;
                const targetRate = currencies[targetCode].rate;
                const result = amountInUSD * targetRate;
                
                const noDecimal = ['JPY', 'KRW', 'IDR'];
                if (noDecimal.includes(targetCode)) {
                    document.getElementById(`input-${targetRowId}`).value = Math.round(result);
                } else {
                    document.getElementById(`input-${targetRowId}`).value = result.toFixed(2);
                }
            }
        });
    }
</script>

</body>
</html>
